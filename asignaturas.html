<script>
  document.addEventListener('DOMContentLoaded', () => {
    fetchAsignaturas();
  });

  // Obtener todas las asignaturas
  function fetchAsignaturas() {
    fetch('https://proyectofinal-mzx3.onrender.com/api/asignaturas')
      .then(response => response.json())
      .then(data => {
        const tableBody = document.querySelector('table tbody');
        tableBody.innerHTML = '';

        data.forEach(asignatura => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${asignatura._id}</td>
            <td>${asignatura.nombre}</td>
            <td>${asignatura.codigo}</td>
            <td>${asignatura.descripcion}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editarAsignatura('${asignatura._id}')"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="eliminarAsignatura('${asignatura._id}')"><i class="bi bi-trash"></i></button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      })
      .catch(error => console.error('Error al cargar las asignaturas:', error));
  }

  // Editar una asignatura
  function editarAsignatura(id) {
    fetch(`https://proyectofinal-mzx3.onrender.com/api/asignaturas/${id}`)
      .then(response => response.json())
      .then(asignatura => {
        const form = document.querySelector('#formAsignatura');
        form.querySelector('input[name="nombre"]').value = asignatura.nombre;
        form.querySelector('input[name="codigo"]').value = asignatura.codigo;
        form.querySelector('textarea[name="descripcion"]').value = asignatura.descripcion;

        // Cambiar el comportamiento del formulario a actualizar
        form.onsubmit = (e) => {
          e.preventDefault();
          actualizarAsignatura(id);
        };
        // Mostrar el modal
        new bootstrap.Modal(document.getElementById('modalAsignatura')).show();
      })
      .catch(error => console.error('Error al cargar los datos de la asignatura:', error));
  }

  // Actualizar asignatura
  function actualizarAsignatura(id) {
    const form = document.querySelector('#formAsignatura');
    const asignaturaData = {
      nombre: form.querySelector('input[name="nombre"]').value,
      codigo: form.querySelector('input[name="codigo"]').value,
      descripcion: form.querySelector('textarea[name="descripcion"]').value,
    };

    fetch(`https://proyectofinal-mzx3.onrender.com/api/asignaturas/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(asignaturaData)
    })
    .then(response => response.json())
    .then(data => {
      console.log('Asignatura actualizada:', data);
      fetchAsignaturas();  // Refrescar la lista de asignaturas
      document.querySelector('#modalAsignatura').modal('hide');  // Cerrar el modal
    })
    .catch(error => console.error('Error al actualizar la asignatura:', error));
  }

  // Eliminar asignatura
  function eliminarAsignatura(id) {
    if (confirm('¿Estás seguro de que quieres eliminar esta asignatura?')) {
      fetch(`https://proyectofinal-mzx3.onrender.com/api/asignaturas/${id}`, {
        method: 'DELETE'
      })
      .then(() => {
        console.log('Asignatura eliminada');
        fetchAsignaturas();  // Refrescar la lista de asignaturas
      })
      .catch(error => console.error('Error al eliminar la asignatura:', error));
    }
  }

  // Agregar una nueva asignatura
  document.querySelector('#formAsignatura').addEventListener('submit', (e) => {
    e.preventDefault();
    const form = e.target;
    const asignaturaData = {
      nombre: form.querySelector('input[name="nombre"]').value,
      codigo: form.querySelector('input[name="codigo"]').value,
      descripcion: form.querySelector('textarea[name="descripcion"]').value,
    };

    fetch('https://proyectofinal-mzx3.onrender.com/api/asignaturas', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(asignaturaData)
    })
    .then(response => response.json())
    .then(data => {
      console.log('Asignatura agregada:', data);
      fetchAsignaturas();  // Refrescar la lista de asignaturas
      document.querySelector('#modalAsignatura').modal('hide');  // Cerrar el modal
    })
    .catch(error => console.error('Error al agregar la asignatura:', error));
  });
</script>
